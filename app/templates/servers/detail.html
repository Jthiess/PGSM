{% extends 'base.html' %}
{% block title %}- {{ server.name }}{% endblock %}

{% block content %}
<div class="detail-header">
    <div>
        <div class="detail-title">{{ server.name }}</div>
        <div class="detail-subtitle">
            {{ server.server_type | capitalize }} &bull;
            {{ server.game_version }} &bull;
            CT {{ server.ct_id }} on {{ server.proxmox_node }}
        </div>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <span class="badge badge-{{ server.status }}" id="status-badge">{{ server.status }}</span>
        <div class="detail-actions">
            {% if server.status == 'running' %}
                <form method="POST" action="{{ url_for('servers.stop', server_id=server.id) }}" style="display:inline">
                    <button class="btn btn-warning btn-sm">&#9646; Stop</button>
                </form>
                <form method="POST" action="{{ url_for('servers.restart', server_id=server.id) }}" style="display:inline">
                    <button class="btn btn-secondary btn-sm">&#8635; Restart</button>
                </form>
            {% elif server.status in ['stopped', 'error'] %}
                <form method="POST" action="{{ url_for('servers.start', server_id=server.id) }}" style="display:inline">
                    <button class="btn btn-success btn-sm">&#9654; Start</button>
                </form>
            {% else %}
                <button class="btn btn-secondary btn-sm" disabled>Provisioning...</button>
            {% endif %}
            <a href="{{ url_for('console.console', server_id=server.id) }}" class="btn btn-primary btn-sm">Console</a>
            <a href="{{ url_for('files.browse', server_id=server.id) }}" class="btn btn-secondary btn-sm">Files</a>
        </div>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-field">
        <div class="detail-field-label">IP Address</div>
        <div class="detail-field-value">{{ server.ip_address }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Port</div>
        <div class="detail-field-value">{{ server.game_port }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Cores</div>
        <div class="detail-field-value">{{ server.cores }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Memory</div>
        <div class="detail-field-value">{{ server.memory_mb }} MB</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Disk</div>
        <div class="detail-field-value">{{ server.disk_gb }} GB</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Container ID</div>
        <div class="detail-field-value">{{ server.ct_id }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Hostname</div>
        <div class="detail-field-value">{{ server.hostname }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Created</div>
        <div class="detail-field-value">{{ server.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
</div>

<div class="tabs">
    <a class="tab active" data-tab="info" href="#">Info</a>
    <a class="tab" data-tab="game-settings" href="#">Game Settings</a>
</div>

<div id="tab-info" class="tab-panel">
    <div class="card">
        <div class="detail-grid">
            <div class="detail-field">
                <div class="detail-field-label">MOTD</div>
                <div class="detail-field-value">{{ server.motd or 'A PGSM Minecraft Server' }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">Difficulty</div>
                <div class="detail-field-value">{{ server.difficulty }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">Render Distance</div>
                <div class="detail-field-value">{{ server.render_distance }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">Spawn Protection</div>
                <div class="detail-field-value">{{ server.spawn_protection }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">Hardcore</div>
                <div class="detail-field-value">{{ 'Yes' if server.hardcore else 'No' }}</div>
            </div>
            {% if server.java_version %}
            <div class="detail-field">
                <div class="detail-field-label">Java Version</div>
                <div class="detail-field-value">{{ server.java_version }}</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="tab-game-settings" class="tab-panel" style="display:none">
    <div class="card">
        <p class="text-muted" style="font-size: 0.875rem;">
            To change game settings, edit <code>/PGSM/server.properties</code> via the
            <a href="{{ url_for('files.browse', server_id=server.id) }}">file manager</a>
            and restart the server.
        </p>
    </div>
</div>

<div class="danger-zone">
    <h3>Danger Zone</h3>
    <p>Permanently delete this server and its Proxmox container. This cannot be undone.</p>
    <form method="POST" action="{{ url_for('servers.delete', server_id=server.id) }}"
          onsubmit="return confirm('Are you sure you want to permanently delete {{ server.name }}?')">
        <button type="submit" class="btn btn-danger btn-sm">Delete Server</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab switching
document.querySelectorAll('.tab').forEach(function(tab) {
    tab.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
    });
});

// Poll status while creating
const badge = document.getElementById('status-badge');
if (badge && badge.textContent.trim() === 'creating') {
    const interval = setInterval(function() {
        fetch('/api/servers/{{ server.id }}/status')
            .then(r => r.json())
            .then(data => {
                const status = data.db_status;
                badge.textContent = status;
                badge.className = 'badge badge-' + status;
                if (status !== 'creating') {
                    clearInterval(interval);
                    location.reload();
                }
            })
            .catch(() => {});
    }, 5000);
}
</script>
{% endblock %}
