{% extends 'base.html' %}
{% block title %}- {{ server.name }}{% endblock %}

{% block content %}
<div class="detail-header">
    <div>
        <div class="detail-title">{{ server.name }}</div>
        <div class="detail-subtitle">
            {{ server.server_type | capitalize }} &bull;
            {{ server.game_version }} &bull;
            CT {{ server.ct_id }} on {{ server.proxmox_node }}
        </div>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <span class="badge badge-{{ server.status }}" id="status-badge">{{ server.status }}</span>
        {% if server.status == 'running' %}
        <span class="badge-players" id="player-count">
            <span id="players-online">--</span>/<span id="players-max">--</span> players
        </span>
        {% endif %}
        <div class="detail-actions">
            {% if server.status == 'running' %}
                <form method="POST" action="{{ url_for('servers.stop', server_id=server.id) }}" style="display:inline">
                    <button class="btn btn-warning btn-sm">&#9646; Stop</button>
                </form>
                <form method="POST" action="{{ url_for('servers.restart', server_id=server.id) }}" style="display:inline">
                    <button class="btn btn-secondary btn-sm">&#8635; Restart</button>
                </form>
            {% elif server.status in ['stopped', 'error'] %}
                <form method="POST" action="{{ url_for('servers.start', server_id=server.id) }}" style="display:inline">
                    <button class="btn btn-success btn-sm">&#9654; Start</button>
                </form>
            {% else %}
                <button class="btn btn-secondary btn-sm" disabled>Provisioning...</button>
            {% endif %}
            <a href="{{ url_for('console.console', server_id=server.id) }}" class="btn btn-primary btn-sm">Console</a>
            <a href="{{ url_for('files.browse', server_id=server.id) }}" class="btn btn-secondary btn-sm">Files</a>
        </div>
    </div>
</div>

<div class="detail-grid">
    <div class="detail-field">
        <div class="detail-field-label">IP Address</div>
        <div class="detail-field-value">{{ server.ip_address }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Ports</div>
        <div class="detail-field-value">{{ server.all_ports | join(', ') }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Cores</div>
        <div class="detail-field-value">{{ server.cores }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Memory</div>
        <div class="detail-field-value">{{ server.memory_mb }} MB</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Disk</div>
        <div class="detail-field-value">{{ server.disk_gb }} GB</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Container ID</div>
        <div class="detail-field-value">{{ server.ct_id }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Hostname</div>
        <div class="detail-field-value">{{ server.hostname }}</div>
    </div>
    <div class="detail-field">
        <div class="detail-field-label">Created</div>
        <div class="detail-field-value">{{ server.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
</div>

<div class="tabs">
    <a class="tab {% if active_tab == 'info' %}active{% endif %}" data-tab="info" href="#">Info</a>
    <a class="tab {% if active_tab == 'game-settings' %}active{% endif %}" data-tab="game-settings" href="#">Game Settings</a>
    <a class="tab {% if active_tab == 'ports' %}active{% endif %}" data-tab="ports" href="#">Ports</a>
    <a class="tab {% if active_tab == 'monitoring' %}active{% endif %}" data-tab="monitoring" href="#">Monitoring</a>
</div>

<div id="tab-info" class="tab-panel" {% if active_tab != 'info' %}style="display:none"{% endif %}>
    <div class="card">
        <div class="detail-grid">
            <div class="detail-field">
                <div class="detail-field-label">MOTD</div>
                <div class="detail-field-value">{{ server.motd or 'A PGSM Minecraft Server' }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">Difficulty</div>
                <div class="detail-field-value">{{ server.difficulty }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">Render Distance</div>
                <div class="detail-field-value">{{ server.render_distance }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">Spawn Protection</div>
                <div class="detail-field-value">{{ server.spawn_protection }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">Hardcore</div>
                <div class="detail-field-value">{{ 'Yes' if server.hardcore else 'No' }}</div>
            </div>
            <div class="detail-field">
                <div class="detail-field-label">High Availability</div>
                <div class="detail-field-value">{{ 'Enabled' if server.ha_enabled else 'Disabled' }}</div>
            </div>
            {% if server.java_version %}
            <div class="detail-field">
                <div class="detail-field-label">Java Version</div>
                <div class="detail-field-value">{{ server.java_version }}</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="tab-game-settings" class="tab-panel" {% if active_tab != 'game-settings' %}style="display:none"{% endif %}>
    <div class="card">
        <form method="POST" action="{{ url_for('servers.update_settings', server_id=server.id) }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="motd">MOTD</label>
                    <input type="text" id="motd" name="motd"
                           value="{{ server.motd or '' }}"
                           placeholder="A PGSM Minecraft Server">
                </div>
                <div class="form-group">
                    <label for="difficulty">Difficulty</label>
                    <select id="difficulty" name="difficulty">
                        {% for d in ['peaceful', 'easy', 'normal', 'hard'] %}
                        <option value="{{ d }}" {% if server.difficulty == d %}selected{% endif %}>
                            {{ d | capitalize }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="render_distance">Render Distance</label>
                    <input type="number" id="render_distance" name="render_distance"
                           value="{{ server.render_distance }}" min="2" max="32">
                </div>
                <div class="form-group">
                    <label for="spawn_protection">Spawn Protection</label>
                    <input type="number" id="spawn_protection" name="spawn_protection"
                           value="{{ server.spawn_protection }}" min="0" max="100">
                </div>
            </div>
            <div class="form-group">
                <div class="checkbox-row">
                    <input type="checkbox" id="hardcore" name="hardcore"
                           {% if server.hardcore %}checked{% endif %}>
                    <label for="hardcore">Hardcore mode</label>
                </div>
            </div>
            <div style="display: flex; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                <button type="submit" class="btn btn-primary btn-sm">Save Settings</button>
                <span class="text-muted" style="font-size: 0.8rem;">
                    A server restart is required for changes to take effect.
                </span>
            </div>
        </form>
    </div>
</div>

<div id="tab-ports" class="tab-panel" {% if active_tab != 'ports' %}style="display:none"{% endif %}>
    <div class="card">
        <h3 class="section-title" style="margin-bottom: 0.5rem;">Port Management</h3>
        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.25rem;">
            All ports are proxied via nginx on the controller. The primary port is also used for Minecraft status pings.
        </p>

        <!-- Port list -->
        <table style="margin-bottom: 1.25rem;">
            <thead>
                <tr>
                    <th>Port</th>
                    <th>Type</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="ports-table-body">
                <tr>
                    <td class="text-mono">{{ server.game_port }}</td>
                    <td><span class="badge badge-running" style="font-size: 0.7rem;">Primary</span></td>
                    <td><span class="text-muted" style="font-size: 0.8rem;">Cannot remove</span></td>
                </tr>
                {% for port in server.extra_ports or [] %}
                <tr id="port-row-{{ port }}">
                    <td class="text-mono">{{ port }}</td>
                    <td><span class="badge badge-stopped" style="font-size: 0.7rem;">Extra</span></td>
                    <td>
                        <button class="btn btn-ghost btn-sm" style="color: var(--accent-danger);"
                                onclick="removePort({{ port }})">Remove</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Add port -->
        <div class="flex gap-1 items-center" style="flex-wrap: wrap;">
            <input type="number" id="new-port-input" placeholder="Port (1024â€“65535)"
                   min="1024" max="65535" style="width: 200px;">
            <button class="btn btn-primary btn-sm" onclick="addPort()">Add Port</button>
            <span id="ports-feedback" style="font-size: 0.82rem; color: var(--accent-danger); display:none;"></span>
        </div>
    </div>
</div>

<div id="tab-monitoring" class="tab-panel" {% if active_tab != 'monitoring' %}style="display:none"{% endif %}>
    <div class="card">
        {% if server.status == 'running' %}
        <div class="monitor-grid">
            <div class="monitor-metric">
                <div class="monitor-label">CPU Usage</div>
                <div class="monitor-bar-wrap">
                    <div class="monitor-bar" id="cpu-bar" style="width:0%"></div>
                </div>
                <div class="monitor-value" id="cpu-value">--</div>
            </div>
            <div class="monitor-metric">
                <div class="monitor-label">Memory</div>
                <div class="monitor-bar-wrap">
                    <div class="monitor-bar" id="mem-bar" style="width:0%"></div>
                </div>
                <div class="monitor-value" id="mem-value">-- / -- MB</div>
            </div>
            <div class="monitor-metric">
                <div class="monitor-label">Network I/O</div>
                <div class="monitor-value" id="net-value">--</div>
                <div class="monitor-hint">Receive / Transmit rate</div>
            </div>
        </div>
        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-muted);" id="metrics-last-updated">
            Waiting for first update...
        </div>
        {% else %}
        <p class="text-muted" style="font-size: 0.875rem;">
            Start the server to view live metrics.
        </p>
        {% endif %}
    </div>
</div>

<div class="danger-zone">
    <h3>Danger Zone</h3>
    <p>Permanently delete this server and its Proxmox container. This cannot be undone.</p>
    <form method="POST" action="{{ url_for('servers.delete', server_id=server.id) }}"
          onsubmit="return confirm('Are you sure you want to permanently delete {{ server.name }}?')">
        <button type="submit" class="btn btn-danger btn-sm">Delete Server</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab switching
document.querySelectorAll('.tab').forEach(function(tab) {
    tab.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
    });
});

// Poll status while creating
const badge = document.getElementById('status-badge');
if (badge && badge.textContent.trim() === 'creating') {
    const interval = setInterval(function() {
        fetch('/api/servers/{{ server.id }}/status')
            .then(r => r.json())
            .then(data => {
                const status = data.db_status;
                badge.textContent = status;
                badge.className = 'badge badge-' + status;
                if (status !== 'creating') {
                    clearInterval(interval);
                    location.reload();
                }
            })
            .catch(() => {});
    }, 5000);
}

{% if server.status == 'running' %}
// Live metrics polling - 2s interval for responsiveness
(function() {
    var netSamples = [];
    var MAX_SAMPLES = 5;  // Average last 5 samples (10 seconds at 2s polling)

    function fmtBytes(b) {
        if (b === null || b === undefined || isNaN(b)) return '--';
        if (b < 1024) return b.toFixed(0) + ' B';
        if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
        if (b < 1073741824) return (b / 1048576).toFixed(1) + ' MB';
        return (b / 1073741824).toFixed(2) + ' GB';
    }

    function updateBar(barEl, pct) {
        barEl.style.width = Math.min(pct, 100) + '%';
        barEl.classList.remove('warn', 'crit');
        if (pct >= 90) barEl.classList.add('crit');
        else if (pct >= 70) barEl.classList.add('warn');
    }

    function pollMetrics() {
        fetch('/api/servers/{{ server.id }}/metrics')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                // CPU
                if (data.cpu_percent !== null) {
                    updateBar(document.getElementById('cpu-bar'), data.cpu_percent);
                    document.getElementById('cpu-value').textContent = data.cpu_percent.toFixed(1) + '%';
                }

                // Memory
                if (data.memory_used_mb !== null && data.memory_total_mb !== null) {
                    var pct = Math.round(data.memory_used_mb / data.memory_total_mb * 100);
                    updateBar(document.getElementById('mem-bar'), pct);
                    document.getElementById('mem-value').textContent =
                        data.memory_used_mb + ' / ' + data.memory_total_mb + ' MB';
                }

                // Network - average over last N samples for smoother display
                var netEl = document.getElementById('net-value');
                if (data.net_rx_bytes !== null) {
                    netSamples.push({
                        rx: data.net_rx_bytes,
                        tx: data.net_tx_bytes,
                        time: Date.now()
                    });

                    if (netSamples.length > MAX_SAMPLES) {
                        netSamples.shift();
                    }

                    if (netSamples.length >= 2) {
                        var oldest = netSamples[0];
                        var newest = netSamples[netSamples.length - 1];
                        var dt = (newest.time - oldest.time) / 1000;
                        if (dt > 0) {
                            var avgRxRate = (newest.rx - oldest.rx) / dt;
                            var avgTxRate = (newest.tx - oldest.tx) / dt;
                            netEl.innerHTML = fmtBytes(avgRxRate) + '/s &darr;&nbsp;&nbsp;' + fmtBytes(avgTxRate) + '/s &uarr;';
                        }
                    } else {
                        netEl.textContent = 'Measuring...';
                    }
                }

                // Player count in header
                var onlineEl = document.getElementById('players-online');
                var maxEl = document.getElementById('players-max');
                if (onlineEl && data.players_online !== null) {
                    onlineEl.textContent = data.players_online;
                    maxEl.textContent = data.players_max;
                }

                // Last updated
                var lu = document.getElementById('metrics-last-updated');
                if (lu) lu.textContent = 'Updated: ' + new Date().toLocaleTimeString();
            })
            .catch(function() {});
    }

    pollMetrics();
    setInterval(pollMetrics, 2000);  // Poll every 2 seconds for responsiveness
})();
{% endif %}

// Port management
var SERVER_ID = '{{ server.id }}';
var PRIMARY_PORT = {{ server.game_port }};

function showPortFeedback(msg, isError) {
    var el = document.getElementById('ports-feedback');
    el.textContent = msg;
    el.style.color = isError ? 'var(--accent-danger)' : 'var(--accent-success)';
    el.style.display = '';
    setTimeout(function() { el.style.display = 'none'; }, 4000);
}

function addPort() {
    var input = document.getElementById('new-port-input');
    var port = parseInt(input.value, 10);
    if (!port || port < 1024 || port > 65535) {
        showPortFeedback('Port must be between 1024 and 65535.', true);
        return;
    }
    fetch('/api/servers/' + SERVER_ID + '/ports/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({port: port}),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { showPortFeedback(data.error, true); return; }
        input.value = '';
        // Add row to table
        var tbody = document.getElementById('ports-table-body');
        var tr = document.createElement('tr');
        tr.id = 'port-row-' + port;
        tr.innerHTML =
            '<td class="text-mono">' + port + '</td>' +
            '<td><span class="badge badge-stopped" style="font-size:0.7rem;">Extra</span></td>' +
            '<td><button class="btn btn-ghost btn-sm" style="color:var(--accent-danger);" ' +
            'onclick="removePort(' + port + ')">Remove</button></td>';
        tbody.appendChild(tr);
        if (data.nginx_warning) {
            showPortFeedback('Port added, but nginx reload failed: ' + data.nginx_warning, true);
        } else {
            showPortFeedback('Port ' + port + ' added.', false);
        }
    })
    .catch(function() { showPortFeedback('Request failed.', true); });
}

function removePort(port) {
    if (!confirm('Remove port ' + port + '?')) return;
    fetch('/api/servers/' + SERVER_ID + '/ports/remove', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({port: port}),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { showPortFeedback(data.error, true); return; }
        var row = document.getElementById('port-row-' + port);
        if (row) row.remove();
        if (data.nginx_warning) {
            showPortFeedback('Port removed, but nginx reload failed: ' + data.nginx_warning, true);
        } else {
            showPortFeedback('Port ' + port + ' removed.', false);
        }
    })
    .catch(function() { showPortFeedback('Request failed.', true); });
}
</script>
{% endblock %}
